<section class="space-y-8">
  <div class="grid gap-6 md:grid-cols-2">
    <div class="rounded-lg bg-white p-6 shadow">
      <p class="text-sm uppercase text-gray-500">Total pendente</p>
      <p class="mt-3 text-4xl font-semibold text-rstred">&euro; <%= (totals.totalPending || 0).toFixed(2) %></p>
    </div>
    <div class="rounded-lg bg-white p-6 shadow">
      <p class="text-sm uppercase text-gray-500">Total pago</p>
      <p class="mt-3 text-4xl font-semibold text-green-600">&euro; <%= (totals.totalPaid || 0).toFixed(2) %></p>
    </div>
  </div>
  <div class="rounded-lg bg-white p-6 shadow">
    <h2 class="mb-4 text-lg font-semibold text-rstgray">Sincronização manual</h2>
    <form method="POST" action="/admin/orders/sync" class="space-y-4">
      <p class="text-sm text-gray-600">
        Gera comissões para encomendas recentes do Prestashop nas situações em que exista um afiliado associado.
      </p>
      <button
        type="submit"
        class="rounded bg-rstred px-4 py-2 text-sm font-semibold uppercase text-white">
        Sincronizar encomendas
      </button>
    </form>
  </div>
  <div class="rounded-lg bg-white p-6 shadow">
    <div class="mb-4 flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-rstgray">Encomendas atribuídas</h2>
        <p class="text-sm text-gray-500">Clique para ver os produtos e comissões por linha.</p>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-left text-sm">
        <thead class="text-xs uppercase text-gray-500">
          <tr>
            <th class="px-4 py-2">Encomenda</th>
            <th class="px-4 py-2">Afiliado</th>
            <th class="px-4 py-2">Primeira compra</th>
            <th class="px-4 py-2">Total</th>
            <th class="px-4 py-2">Total (s/IVA)</th>
            <th class="px-4 py-2">Comissão</th>
            <th class="px-4 py-2">Data</th>
            <th class="px-4 py-2 text-right"></th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach((order) => { 
               const orderLink = `https://rstferramentas.com/cms/index.php/sell/orders/${order.prestashop_order_id}/view`;
               const uniquePerc = Array.from(new Set((order.products || []).map((p) => p.percentage).filter((p) => p !== null)));
          %>
            <tr class="border-t align-top hover:bg-gray-50 cursor-pointer" data-expand-target="order-<%= order.id %>">
              <td class="px-4 py-2">
                <div class="flex items-center gap-2">
                  <a class="font-semibold text-rstred hover:underline" href="<%= orderLink %>" target="_blank" rel="noopener noreferrer">#<%= order.prestashop_order_id %></a>
                </div>
              </td>
              <td class="px-4 py-2 font-medium text-rstgray"><%= order.afiliado_name %></td>
              <td class="px-4 py-2"><%= order.is_first_purchase_commission ? 'Sim' : 'Nao' %></td>
              <td class="px-4 py-2">&euro; <%= Number(order.order_total_with_vat || 0).toFixed(2) %></td>
              <td class="px-4 py-2">&euro; <%= Number(order.order_total_without_vat || 0).toFixed(2) %></td>
              <td class="px-4 py-2 font-semibold text-rstred">
                &euro; <%= Number(order.commission_earned || 0).toFixed(2) %>
                <% if (uniquePerc.length === 1) { %>
                  <span class="ml-1 text-xs text-gray-500">(<%= uniquePerc[0] %>%)</span>
                <% } %>
              </td>
              <td class="px-4 py-2 text-gray-500"><%= new Date(order.order_created_at).toLocaleDateString() %></td>
              <td class="px-4 py-2 text-right">
                <form method="POST" action="/admin/orders/<%= order.id %>/delete" onsubmit="event.stopPropagation(); return confirm('Tem a certeza que quer remover esta encomenda? Ela podera ser sincronizada novamente se se aplicar alguma regra.');">
                  <button type="submit" class="rounded bg-red-50 px-2 py-1 text-sm font-semibold text-red-600 hover:bg-red-100" onclick="event.stopPropagation();" aria-label="Apagar encomenda">
                    x
                  </button>
                </form>
              </td>
            </tr>
            <tr id="order-<%= order.id %>" class="hidden border-t bg-gray-50">
              <td colspan="8" class="px-4 py-3">
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm">
                    <thead class="text-xs uppercase text-gray-500">
                      <tr>
                        <th class="px-3 py-2" style="width:175px">Marca</th>
                        <th class="px-3 py-2">Referência</th>
                        <th class="px-3 py-2">Produto</th>
                        <th class="px-3 py-2" style="width: 110px;">Quantidade</th>
                        <th class="px-3 py-2" style="width: 110px;">Preço (s/IVA)</th>
                        <th class="px-3 py-2" style="width: 110px;">Comissão</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% (order.products || []).forEach((product) => { 
                           const productLink = `https://rstferramentas.com/index.php?controller=product&id_product=${product.productId}`;
                      %>
                        <tr class="border-t">
                          <td class="px-3 py-2 text-gray-600"><%= product.brandName || '--' %></td>
                          <td class="px-3 py-2 text-gray-600"><%= product.reference %></td>
                          <td class="px-3 py-2 font-medium text-rstgray">
                            <a class="hover:underline" href="<%= productLink %>" target="_blank" rel="noopener noreferrer"><%= product.name || 'Produto' %></a>
                          </td>
                          <td class="px-3 py-2"><%= product.quantity %></td>
                          <td class="px-3 py-2">&euro; <%= Number(product.priceWithoutVat || 0).toFixed(2) %></td>
                          <td class="px-3 py-2 font-semibold text-rstred">
                            &euro; <%= Number(product.commissionAmount || 0).toFixed(2) %>
                            <% if (product.percentage != null) { %>
                              <span class="ml-1 text-xs text-gray-500">(<%= product.percentage %>%)</span>
                            <% } else { %>
                              <span class="ml-1 text-xs text-gray-400">sem regra</span>
                            <% } %>
                          </td>
                        </tr>
                      <% }) %>
                      <% if (!(order.products && order.products.length)) { %>
                        <tr>
                          <td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500">Sem detalhes de produtos para esta encomenda.</td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          <% }) %>
          <% if (!orders.length) { %>
            <tr>
              <td colspan="8" class="px-4 py-6 text-center text-sm text-gray-500">Sem encomendas atribuidas.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-expand-target]').forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('a, button, form')) return;
        const targetId = row.getAttribute('data-expand-target');
        const detailRow = document.getElementById(targetId);
        if (detailRow) {
          detailRow.classList.toggle('hidden');
        }
      });
    });
  });
</script>
